// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.
// See the @microsoft/rush package's LICENSE file for license information.

// THIS FILE WAS GENERATED BY A TOOL. ANY MANUAL MODIFICATIONS WILL GET OVERWRITTEN WHENEVER RUSH IS UPGRADED.
//
// This script is intended for usage in an automated build environment where the Rush command may not have
// been preinstalled, or may have an unpredictable version.  This script will automatically install the version of Rush
// specified in the rush.json configuration file (if not already installed), and then pass a command-line to it.
// An example usage would be:
//
//    node common/scripts/install-run-rush.js install
//
// For more information, see: https://rushjs.io/pages/maintainer/setup_new_repo/

import * as path from 'path';
import * as fs from 'fs';

import {
  installAndRun,
  findRushJsonFolder,
  RUSH_JSON_FILENAME,
  runWithErrorAndStatusCode,
  ILogger
} from './install-run';

const PACKAGE_NAME: string = '@microsoft/rush';
const RUSH_PREVIEW_VERSION: string = 'RUSH_PREVIEW_VERSION';

function _getRushVersion(logger: ILogger): string {
  const rushPreviewVersion: string | undefined = process.env[RUSH_PREVIEW_VERSION];
  if (rushPreviewVersion !== undefined) {
    logger.info(`Using Rush version from environment variable ${RUSH_PREVIEW_VERSION}=${rushPreviewVersion}`);
    return rushPreviewVersion;
  }

  const rushJsonFolder: string = findRushJsonFolder();
  const rushJsonPath: string = path.join(rushJsonFolder, RUSH_JSON_FILENAME);
  try {
    const rushJsonContents: string = fs.readFileSync(rushJsonPath, 'utf-8');
    // Use a regular expression to parse out the rushVersion value because rush.json supports comments,
    // but JSON.parse does not and we don't want to pull in more dependencies than we need to in this script.
    const rushJsonMatches: string[] = rushJsonContents.match(
      /\"rushVersion\"\s*\:\s*\"([0-9a-zA-Z.+\-]+)\"/
    )!;
    return rushJsonMatches[1];
  } catch (e) {
    throw new Error(
      `Unable to determine the required version of Rush from rush.json (${rushJsonFolder}). ` +
        "The 'rushVersion' field is either not assigned in rush.json or was specified " +
        'using an unexpected syntax.'
    );
  }
}

function _run(): void {
  const [
    nodePath /* Ex: /bin/node */,
    scriptPath /* /repo/common/scripts/install-run-rush.js */,
    ...packageBinArgs /* [build, --to, myproject] */
  ]: string[] = process.argv;

  // Detect if this script was directly invoked, or if the install-run-rushx script was invokved to select the
  // appropriate binary inside the rush package to run
  const scriptName: string = path.basename(scriptPath);
  const bin: string = scriptName.toLowerCase() === 'install-run-rushx.js' ? 'rushx' : 'rush';
  if (!nodePath || !scriptPath) {
    throw new Error('Unexpected exception: could not detect node path or script path');
  }

  let commandFound: boolean = false;
  let logger: ILogger = { info: console.log, error: console.error };

  for (const arg of packageBinArgs) {
    if (arg === '-q' || arg === '--quiet') {
      // The -q/--quiet flag is supported by both `rush` and `rushx`, and will suppress
      // any normal informational/diagnostic information printed during startup.
      //
      // To maintain the same user experience, the install-run* scripts pass along this
      // flag but also use it to suppress any diagnostic information normally printed
      // to stdout.
      logger = {
        info: () => {},
        error: console.error
      };
    } else if (!arg.startsWith('-') || arg === '-h' || arg === '--help') {
      // We either found something that looks like a command (i.e. - doesn't start with a "-"),
      // or we found the -h/--help flag flag, which can be run without a command
      commandFound = true;
    }
  }

  if (!commandFound) {
    console.log(`Usage: ${scriptName} <command> [args...]`);
    if (scriptName === 'install-run-rush.js') {
      console.log(`Example: ${scriptName} build --to myproject`);
    } else {
      console.log(`Example: ${scriptName} custom-command`);
    }
    process.exit(1);
  }

  runWithErrorAndStatusCode(logger, () => {
    const version: string = _getRushVersion(logger);
    logger.info(`The rush.json configuration requests Rush version ${version}`);

    return installAndRun(logger, PACKAGE_NAME, version, bin, packageBinArgs);
  });
}

_run();
